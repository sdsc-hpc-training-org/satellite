# apache24-master.conf
#

###############################################################################
# modules to load on all instances
###############################################################################
LoadModule macro_module modules/mod_macro.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule include_module modules/mod_include.so
LoadModule env_module modules/mod_env.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule socache_shmcb_module modules/mod_socache_shmcb.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule mime_magic_module modules/mod_mime_magic.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule mime_module modules/mod_mime.so
LoadModule vhost_alias_module modules/mod_vhost_alias.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
#LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so


###############################################################################
# static defaults for all instances (does not involve variable expansion)
###############################################################################

# Log-related
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
HostnameLookups Off
LogLevel warn

# Server identification
# reduce info given to threat-actors
ServerSignature Off
ServerTokens ProductOnly

# Connection parameters
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 15
UseCanonicalName On

DirectoryIndex index.php index.html index.htm

# Access controls
AccessFileName .htaccess

# don't serve dotfiles (includes .htaccess)
<Files ~ "^\.">
    Require all denied
</Files>

# restrictive permissions by default
<Directory />
    Options FollowSymLinks
    Require all denied
</Directory>


<IfModule mod_mime_magic.c>
    MIMEMagicFile conf/magic
</IfModule>

TypesConfig /etc/mime.types
AddDefaultCharset ISO-8859-1
AddCharset ISO-8859-1  .iso8859-1  .latin1
AddCharset UTF-8       .utf8
AddCharset utf-7       .utf7
AddCharset utf-8       .utf8

# SSL Config
SSLPassPhraseDialog  builtin
SSLSessionCacheTimeout  300
SSLSessionCache "shmcb:/tmp/.apache_sslcache(1048576)"

SSLRandomSeed startup file:/dev/urandom 2048
#SSLRandomSeed connect file:/dev/urandom 2048

SSLProtocol all -SSLv2 -SSLv3 -TLSv1
# include MSIE support: SSLCipherSuite DHE-RSA-AES256-SHA:AES256-SHA

# ECDSA cert
#SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256

# RSA cert
SSLCipherSuite DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDH-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-SHA256:TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA:TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA:TLS_DHE_RSA_WITH_AES_128_GCM_SHA256:TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256:DHE-RSA-AES256-SHA

SSLHonorCipherOrder on

SSLUseStapling on
SSLStaplingCache "shmcb:/tmp/.apache_staplingcache(1048576)"


###############################################################################
# Macros
# Using these macros can substantially reduce the size and complexity of
# your typical http config file.
# More info here:
# https://httpd.apache.org/docs/2.4/mod/mod_macro.html
###############################################################################

# This is the default reverse proxy, only at most one per physical host.
# See ReverseProxyVhost for commentary on port numbers and DNAT.
#
# This only handles http requests and consequenty is a bit of a
# misnomer -- it doesn't proxy anything, just redirects!
#
# This does the following:
# - respond to ACME challenges for all vhosts
# - redirect http to https for all vhosts
# - present a default page (?)
<Macro ReverseProxyDefaultHttp>
  # set from init script
  PidFile ${PIDFILE}

  # incoming requests to 80 get DNATed to 4080
  Listen 0.0.0.0:4080

  # Prefork config
  LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
  StartServers             5
  MinSpareServers          5
  MaxSpareServers          15
  MaxRequestWorkers        1500
  MaxConnectionsPerChild   1000
  ServerLimit		1500

  # Doing CGI
  LoadModule cgi_module modules/mod_cgi.so

  # log default accessses
  # there's an ssl and nossl
  # keep the two separate so the files dont get clobbered
  # this is the nossl
  ErrorLog  "| /usr/sbin/cronolog /var/tmp/ssakai-htroot/errors.nossl.%Y%m%d"
  CustomLog "| /usr/sbin/cronolog /var/tmp/ssakai-htroot/access.nossl.%Y%m%d" combined

  <VirtualHost 0.0.0.0:4080>
    ServerAdmin webmaster@sdsc.edu
    ServerName plinky.sdsc.edu

    # this instance serves nothing except the 
    # challenges, and does redirects to https
    # nonetheless, documentroot needs to exist for 
    # everything to work.
    DocumentRoot /var/tmp/ssakai-htdocs/

    # Use this to make letsencrypt certs easy to get with dehydrated
    # https://github.com/lukas2511/dehydrated
    #
    # The target of the alias must be writable by the service account running
    # dehydrated, which MUST NOT be the same account running apache.
    # The target MAY be shared by different sites.
    # The target MUST NOT be writable by any other users (except root).
    # The target MAY have its contents purged as soon as dehydrated is done.
    Alias "/.well-known/acme-challenge" "/www/.acme-challenge"
    <Directory /www/.acme-challenge>
      Options None
      AllowOverride None
      Require all granted
    </Directory>

    # rewrite everything except ACME to https
    #RewriteEngine On
    #RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge [NC]
    #RewriteCond %{HTTPS} !=on
    #RewriteRule ^/?(.*) https://%{HTTP_HOST}/$1 [R=307,L]
  </VirtualHost>
  # allow access to the docroot
  <Directory "/var/tmp/ssakai-htdocs">
    Options Indexes SymLinksIfOwnerMatch Multiviews ExecCGI
    AddHandler cgi-script .cgi
    AllowOverride AuthConfig Indexes FileInfo Limit Options=All,MultiViews
    Require all granted
  </Directory>

</Macro>

# This is the reverse proxy for each deployment
# We implement it as a virtual host, one instance per deployment
#
# The weird port number is because we can't bridge the
# host's interface right into the container, nor be root in the
# container to bind to 443 and 80.
#
# An iptables DNAT rule will route packets to 443/80 in to the container to
# these arbitrary ports.
#
# Note that the (only) http listener is the ReverseProxyDefaultHttp
# it will handle the http->https redirects for all vhosts.
#
# This instance just does ssl
#
# These should follow the contents of httpd-revproxy.conf
<Macro ReverseProxyVhost $deployname $vhost $aliases $certbase>

  # we're listening on https only
  <VirtualHost 0.0.0.0:8443>
    SSLEngine on
    SSLCertificateFile /private_files/letsencrypt/certs/$certbase/cert.pem
    SSLCertificateChainFile /private_files/letsencrypt/certs/$certbase/chain.pem
    SSLCertificateKeyFile /private_files/letsencrypt/certs/$certbase/privkey.pem

    ServerAdmin webmaster@sdsc.edu
    ServerName $vhost
    ServerAlias $aliases
    ErrorLog  "| /usr/sbin/cronolog /www-logs/errors.proxy-$deployname.%Y%m%d"
    CustomLog "| /usr/sbin/cronolog /www-logs/access.proxy-$deployname.%Y%m%d" combined
    ProxyPass "/" "http://$deployname:8080/" disableReuse=On connectiontimeout=30 timeout=3600
    ProxyPassReverse "/" "http://$deployname:8080/"
    
    # backend host has no clue about SSL. let's make sure cookies are set for ssl-only
    Header edit Set-Cookie ^(.*)$ $1;Secure
  
    # HSTS is a good thing, prevents MITM during redirect after first visit
    Header always set Strict-Transport-Security "max-age=31536000;"
  </VirtualHost>
</Macro>


# This block represents a common webfarm site.
# IP based host
<Macro WebfarmIPHost $vhost>
  ErrorLog  "| /usr/sbin/cronolog /www-logs/errors.$vhost.%Y%m%d"
  CustomLog "| /usr/sbin/cronolog /www-logs/access.$vhost.%Y%m%d" combined

  # We're stuck with prefork since mod_php isn't compatible with event
  # Prefork config
  LoadModule mpm_prefork_module modules/mod_mpm_prefork.so

  StartServers             5
  MinSpareServers          5
  MaxSpareServers          15
  MaxRequestWorkers        1500
  MaxConnectionsPerChild   1000
  ServerLimit		1500


  # http redirects to https
  Listen 0.0.0.0:8080
  <VirtualHost 0.0.0.0:8080>
    DocumentRoot /www
    ServerAdmin webmaster@sdsc.edu
    ServerName $vhost
    ProxyTimeout 300
    
  </VirtualHost>

  # allow access to the docroot
  <Directory "/www">
    Options Indexes SymLinksIfOwnerMatch Multiviews
    AllowOverride AuthConfig Indexes FileInfo Limit Options=All,MultiViews
    Require all granted
  </Directory>
</Macro>

<Macro rhphp72>
  LoadModule php7_module modules/librh-php72-php7.so
  <FilesMatch ".+\.ph(p[345]?|t|tml)$">
    SetHandler application/x-httpd-php
  </FilesMatch>
  php_admin_value post_max_size    2049M
  php_admin_value upload_max_filesize    2049M
  php_admin_value upload_tmp_dir    /localtemp
  php_admin_value sys_temp_dir    /localtemp
  php_admin_value realpath_cache_size 512K
  php_admin_value opcache.max_accelerated_files 20000
  php_admin_value opcache.validate_timestamps 0
  php_admin_value max_file_uploads 1000
  php_admin_value memory_limit 256M
</Macro>
